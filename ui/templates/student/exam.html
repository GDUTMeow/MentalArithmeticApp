<!-- 考试入口 -->
<div class="container" id="exam-entrance" style="display: none">
    <div class="row gx-1">
        <div class="col-12">
            <div class="card text-center border border-primary shadow-0 w-100">
                <div class="card-body">
                    <h5 class="card-title" style="padding-bottom: 10px">
                        {{ exam and exam.metadata and exam.metadata.title or "这是一场不存在的考试" }}
                    </h5>
                    <p class="card-text">
                        {{ exam and exam.metadata and exam.metadata.description or "description" }}
                    </p>
                    <button type="button" class="btn btn-primary enter-exam btn-color-dashboard-primary" onclick="initializeExam()">
                        进入考试
                    </button>
                </div>
                <div class="card-footer">
                    剩余时间：{{ exam and exam.metadata and exam.metadata.time_left or 56562 }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 成绩表单 -->
<div class="container" id="exam-finish-prompt" style="display: none">
    <div class="card mt-4">
        <div class="card-body" align="center">
            <h4 class="card-title">考试结束</h4>
            <p class="card-text" id="exam-result-msg"></p>
        </div>
    </div>
</div>

<!-- 考试题目界面 -->
<div class="container" id="exam-container" style="display: none">
    <div class="card mt-4">
        <div class="card-body">
            <h4 class="card-title" id="exam-name">考试名称</h4>
            <div class="question-box mt-4 mb-4" align="center">
                <span id="num1" style="font-size: -webkit-xxx-large; padding-right: 5px">13</span>
                <span class="operator" id="operator" style="
            font-size: -webkit-xxx-large;
            padding-right: 5px;
            padding-left: 5px;
          ">?</span>
                <span id="num2" style="
            font-size: -webkit-xxx-large;
            padding-left: 5px;
            padding-right: 5px;
          ">10</span>
                <span id="equals" style="
                          font-size: -webkit-xxx-large;
                          padding-left: 5px;
                        ">= ?</span>
            </div>
            <p class="text-center text-muted" style="font: bold;">若有小数，请精准到小数点后两位</p>
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="您的答案" id="answer-input" />
            </div>

            <div class="d-flex justify-content-between">
                <button class="btn btn-secondary" id="prev-btn">上一题</button>
                <button class="btn btn-primary" id="next-btn">下一题</button>
            </div>
            <div class="mt-3 text-end">
                <button class="btn btn-success" id="submit-btn" style="display: none">
                    提交试卷
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let examData = null;
    let currentIndex = 0;
    let answers = [];
    let startTime = 0;
    let examId = null;

    const operatorMap = {
        0: "+",
        1: "-",
        2: "×",
        3: "÷",
    };

    async function initializeExam() {
        try {
            const res = await fetch("/api/v1/user/getExamData", {
                method: "GET",
                credentials: "include", // 确保请求携带Cookie
            });
            const data = await res.json();
            if (data.success) {
                examData = data.data;
                examId = examData.id;
                document.getElementById("exam-name").textContent = examData.name;
                const examEntrance = document.getElementById("exam-entrance");
                examEntrance.classList.add("fade-out");
                examEntrance.classList.remove("fade-in");
                examEntrance.style.display = "none";
                const examContainer = document.getElementById("exam-container");
                examContainer.classList.remove("fade-out");
                examContainer.classList.add("fade-in");
                examContainer.style.display = "";
                answers = new Array(examData.questions.count).fill(null);

                // 显示第一题
                showQuestion(0);
                document.getElementById("exam-container").style.display = "block";
                startTime = Math.floor(Date.now() / 1000);
            } else {
                // 获取题目失败的情况
                alert("无法获取考试题目，请稍后重试。");
            }
        } catch (error) {
            console.error("Error initializing exam:", error);
            alert("初始化考试失败，请检查网络连接或稍后重试。");
        }
    }

    function showQuestion(index) {
        const q = examData.questions.data[index];
        document.getElementById("num1").textContent = q.num1;
        document.getElementById("operator").textContent = operatorMap[q.op];
        document.getElementById("num2").textContent = q.num2;
        document.getElementById("answer-input").value =
            answers[index] !== null ? answers[index] : "";

        // 控制按钮显示
        document.getElementById("prev-btn").style.display =
            index === 0 ? "none" : "inline-block";
        document.getElementById("next-btn").style.display =
            index === examData.questions.count - 1 ? "none" : "inline-block";
        document.getElementById("submit-btn").style.display =
            index === examData.questions.count - 1 ? "inline-block" : "none";
    }

    function saveCurrentAnswer() {
        const ans = document.getElementById("answer-input").value;
        answers[currentIndex] = ans;
    }

    document.getElementById("prev-btn").addEventListener("click", () => {
        saveCurrentAnswer();
        if (currentIndex > 0) {
            currentIndex--;
            showQuestion(currentIndex);
        }
    });

    document.getElementById("next-btn").addEventListener("click", () => {
        saveCurrentAnswer();
        if (currentIndex < examData.questions.count - 1) {
            currentIndex++;
            showQuestion(currentIndex);
        }
    });

    document.getElementById("submit-btn").addEventListener("click", async() => {
        saveCurrentAnswer();
        // 提交答案
        const endTime = Math.floor(Date.now() / 1000);
        const timeSpent = endTime - startTime;
        const submitData = {
            id: examId,
            answers: answers,
            timeSpent: timeSpent,
        };

        try {
            const res = await fetch("/api/v1/user/examSubmit", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                credentials: "include", // 包含cookie
                body: JSON.stringify(submitData),
            });

            const result = await res.json();

            // 显示成绩页面
            document.getElementById("exam-container").style.display = "none";
            document.getElementById("scores-list-student").style.display = "block";

            if (result.success) {
                document.getElementById("exam-result-msg").textContent =
                    "提交成功！请前往成绩查看页面查看最终成绩。";
            } else {
                document.getElementById("exam-result-msg").textContent =
                    "提交失败，请稍后重试。";
            }
        } catch (error) {
            console.error("Error submitting exam:", error);
            document.getElementById("exam-result-msg").textContent =
                "提交时发生错误，请稍后重试。";
        }
    });
</script>